<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SendGuide | AI Climbing Shoe Sizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #0D1117; 
            color: #eee;
        }
        
        h1, #resultModel, .font-bold { font-weight: 800; }
        .font-medium { font-weight: 700; }
        .main-container { background-color: #0D1117; max-width: 480px; }
        .accent { color: #FFD73A; }
        .card { 
            background-color: #1A1F24; 
            border: 1px solid #30363d;
        }
        
        .btn-primary { 
            background-color: #FFD73A;
            color: #1A1F24;
            font-weight: 700; 
            transition: all 0.2s; 
        }
        .btn-primary:hover { 
            background-color: #e6c034;
            transform: translateY(-1px); 
        }
        .btn-primary:disabled { 
            background-color: #1A1F24;
            color: #6a737d; 
            cursor: not-allowed; 
        }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 16px; 
            width: 16px; 
            border-radius: 50%; 
            background: #FFD73A; 
            margin-top: -6px; 
            cursor: pointer; 
        }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; 
            height: 4px; 
            cursor: pointer; 
            background: #30363d; 
            border-radius: 2px; 
        }

        .segment-btn {
            border: 1px solid #30363d; 
            background-color: #0D1117; 
            color: #D1D5DB; 
            transition: all 0.2s;
            min-height: 60px;
        }
        .segment-btn:hover { background-color: #1A1F24; }
        .segment-btn.selected-shape {
            background-color: rgba(255, 215, 58, 0.1);
            border-color: #FFD73A; 
            color: #FFD73A; 
            font-weight: 700;
        }
        
        select {
            background-color: #1A1F24;
            border: 1px solid #30363d;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .spinner { 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; 
            border-top-color: #fff; 
            width: 16px; 
            height: 16px; 
            animation: spin 1s ease-in-out infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @keyframes pulse { 
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 58, 0.4); } 
            50% { box-shadow: 0 0 0 5px rgba(255, 215, 58, 0); } 
        }
        .animate-pulse-border { animation: pulse 2s infinite; }
        
        .toggle-bg:after { 
            content: ''; 
            position: absolute; 
            top: 2px; 
            left: 2px; 
            background: white; 
            border-radius: 50%; 
            width: 1.25rem;
            height: 1.25rem;
            transition: all 0.2s ease; 
        }
        input:checked + .toggle-bg:after { 
            transform: translateX(1.25rem);
        }
        input:checked + .toggle-bg { 
            background-color: #FFD73A; 
            border-color: #FFD73A; 
        }

        /* Mobile optimizations */
        @media (max-width: 640px) {
            .main-container { margin: 0; border-radius: 0; }
            .segment-btn { font-size: 11px; padding: 8px; min-height: 55px; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 sm:p-4">

    <div class="main-container w-full rounded-2xl shadow-2xl overflow-hidden border border-gray-800">
        
        <!-- HEADER -->
        <div class="card p-4 sm:p-6 text-center border-b border-gray-700 relative">
            <div class="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-500 text-xs">v2.0</div>
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tighter text-white">
                <i class="fa-solid fa-mountain text-yellow-300 mr-2"></i>SendGuide
            </h1>
            <p class="text-gray-300 text-xs sm:text-sm mt-1">Expert AI Sizing & Reviews</p>
        </div>

        <!-- INPUT FORM -->
        <div id="inputForm" class="p-4 sm:p-6 space-y-4 sm:space-y-6">
            
            <!-- Street Size -->
            <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Street Shoe Size (EU)</label>
                <div class="flex items-center space-x-4">
                    <button onclick="adjustSize(-0.5)" class="w-10 h-10 rounded bg-gray-700 hover:bg-gray-600 text-white font-bold">-</button>
                    <input type="number" id="streetSize" value="42.0" step="0.5" class="w-full text-center card py-2 px-3 text-xl font-bold text-white focus:outline-none focus:border-yellow-300 rounded">
                    <button onclick="adjustSize(0.5)" class="w-10 h-10 rounded bg-gray-700 hover:bg-gray-600 text-white font-bold">+</button>
                </div>
            </div>

            <!-- Foot Shape -->
            <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Foot Shape</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectButton('shape-btn', 'narrow', this)" class="shape-btn segment-btn p-2 sm:p-3 rounded text-xs text-center selected-shape">
                        <i class="fa-solid fa-ruler-vertical block mb-1 text-base sm:text-lg"></i>Narrow
                    </button>
                    <button onclick="selectButton('shape-btn', 'regular', this)" class="shape-btn segment-btn p-2 sm:p-3 rounded text-xs text-center">
                        <i class="fa-solid fa-shoe-prints block mb-1 text-base sm:text-lg"></i>Regular
                    </button>
                    <button onclick="selectButton('shape-btn', 'wide', this)" class="shape-btn segment-btn p-2 sm:p-3 rounded text-xs text-center">
                        <i class="fa-solid fa-expand block mb-1 text-base sm:text-lg"></i>Wide
                    </button>
                </div>
                <input type="hidden" id="footShape" value="narrow">
            </div>
            
            <!-- Climbing Style -->
            <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Primary Climbing Style</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectButton('style-btn', 'indoor', this)" class="style-btn segment-btn p-2 sm:p-3 rounded text-xs text-center selected-shape">
                        <i class="fa-solid fa-person-shelter block mb-1 text-base sm:text-lg"></i>Indoor
                    </button>
                    <button onclick="selectButton('style-btn', 'sport', this)" class="style-btn segment-btn p-2 sm:p-3 rounded text-xs text-center">
                        <i class="fa-solid fa-mountain-sun block mb-1 text-base sm:text-lg"></i>Sport
                    </button>
                    <button onclick="selectButton('style-btn', 'trad', this)" class="style-btn segment-btn p-2 sm:p-3 rounded text-xs text-center">
                        <i class="fa-solid fa-hand-rock block mb-1 text-base sm:text-lg"></i>Trad
                    </button>
                </div>
                <input type="hidden" id="climbingStyle" value="indoor">
            </div>

            <!-- Shoe Type -->
            <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Shoe Type Preference</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectButton('type-btn', 'soft', this)" class="type-btn segment-btn p-2 rounded text-xs text-center selected-shape">
                        <i class="fa-solid fa-feather block mb-1 text-base sm:text-lg"></i>
                        <span class="font-bold text-[10px] sm:text-xs">Soft/Comp</span>
                        <span class="hidden sm:block text-gray-300 text-[9px] mt-1">(Sensitivity)</span>
                    </button>
                    <button onclick="selectButton('type-btn', 'all-around', this)" class="type-btn segment-btn p-2 rounded text-xs text-center">
                        <i class="fa-solid fa-balance-scale block mb-1 text-base sm:text-lg"></i>
                        <span class="font-bold text-[10px] sm:text-xs">Balanced</span>
                        <span class="hidden sm:block text-gray-300 text-[9px] mt-1">(Versatile)</span>
                    </button>
                    <button onclick="selectButton('type-btn', 'stiff', this)" class="type-btn segment-btn p-2 rounded text-xs text-center">
                        <i class="fa-solid fa-gavel block mb-1 text-base sm:text-lg"></i>
                        <span class="font-bold text-[10px] sm:text-xs">Stiff/Edge</span>
                        <span class="hidden sm:block text-gray-300 text-[9px] mt-1">(Support)</span>
                    </button>
                </div>
                <input type="hidden" id="shoeType" value="soft">
            </div>

            <!-- Level -->
            <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Climbing Level</label>
                <select id="level" class="w-full card p-3 text-white focus:outline-none focus:border-yellow-300 rounded">
                    <option value="beginner">Beginner (V0 - V3)</option>
                    <option value="intermediate" selected>Intermediate (V4 - V7)</option>
                    <option value="advanced">Advanced (V8+)</option>
                </select>
            </div>
            
            <!-- Budget -->
            <div>
                <div class="flex justify-between text-sm text-gray-200 mb-2">
                    <label class="font-medium">Max Budget</label>
                    <span class="font-bold text-yellow-300">€<span id="budgetLabel">180</span></span>
                </div>
                <input type="range" id="budget" min="80" max="250" value="180" class="w-full" oninput="document.getElementById('budgetLabel').innerText = this.value">
            </div>
            
            <!-- Fit Preference -->
            <div>
                <div class="flex justify-between text-sm text-gray-200 mb-2">
                    <label class="font-medium">Fit Preference</label>
                    <span class="font-bold text-yellow-300"><span id="fitLabel">Performance</span></span>
                </div>
                <input type="range" id="fitPref" min="0" max="100" value="70" class="w-full" oninput="updateFitLabel(this.value)">
            </div>

            <!-- DEMO MODE -->
            <div class="flex items-center justify-between card p-3 rounded-lg">
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-vial text-yellow-300"></i>
                    <label for="demoMode" class="text-sm font-medium text-gray-200">Demo Mode</label>
                </div>
                <label for="demoMode" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="demoMode" class="sr-only" onchange="toggleDemoText(this.checked)">
                        <div class="toggle-bg block bg-gray-600 border border-gray-500 w-11 h-7 rounded-full"></div>
                    </div>
                </label>
            </div>
            <p id="demoModeText" class="text-xs text-gray-400 text-center">Demo Mode OFF. App will use live AI recommendations.</p>

            <button onclick="calculateFit()" id="calculateButton" class="w-full btn-primary py-3 sm:py-4 rounded-lg text-base sm:text-lg shadow-lg flex items-center justify-center space-x-2">
                <span id="calculateButtonText">Find My Perfect Fit</span>
                <i id="calculateButtonIcon" class="fa-solid fa-bolt"></i>
            </button>

            <p id="errorMessage" class="text-red-400 text-sm text-left hidden mt-4 p-3 border border-red-500 rounded bg-red-900 bg-opacity-20"></p>
        </div>

        <!-- RESULTS -->
        <div id="results" class="hidden w-full">
            <img id="resultImage" src="" alt="Recommended Shoe" class="w-full h-40 sm:h-48 object-cover hidden" onerror="this.style.display='none'">

            <div class="p-4 sm:p-6">
                <div class="text-center mb-4 sm:mb-6 animate-fade-in">
                    <div class="inline-block p-2 px-4 bg-green-900 text-green-300 rounded-full text-xs font-bold mb-2">
                        <i class="fa-solid fa-check-circle mr-1"></i> Expert Choice
                    </div>
                    <h2 class="text-xl sm:text-2xl font-bold text-white" id="resultModel">Loading...</h2>
                    <p class="text-yellow-300 text-2xl sm:text-3xl font-bold mt-2" id="resultSize">EU 00.0</p>
                    <p class="text-gray-400 text-sm mt-1">Optimized for <span id="resultOptimizedFor">Performance</span></p>
                </div>

                <!-- Discount Alert -->
                <div id="discountAlertCard" class="card hidden bg-yellow-900 bg-opacity-30 border-yellow-400 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 relative overflow-hidden animate-fade-in animate-pulse-border">
                    <div class="absolute top-0 left-0 w-1 h-full bg-yellow-300"></div>
                    <h3 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-tags mr-2 text-yellow-300"></i>Discount Alert!</h3>
                    <p class="text-yellow-100 text-sm leading-relaxed" id="discountMessageText">Loading...</p>
                </div>

                <!-- Analysis -->
                <div class="card rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 relative overflow-hidden animate-fade-in">
                    <div class="absolute top-0 left-0 w-1 h-full bg-yellow-300"></div>
                    <h3 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-brain mr-2 text-yellow-300"></i>Sizing Logic</h3>
                    <p class="text-gray-300 text-sm leading-relaxed" id="resultLogic">Loading...</p>
                </div>
                
                <!-- Sources -->
                <div id="scrapedSourcesCard" class="card hidden rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 relative overflow-hidden animate-fade-in">
                    <div class="absolute top-0 left-0 w-1 h-full" style="background-color: #5EF5C8;"></div>
                    <h3 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-globe mr-2" style="color: #5EF5C8;"></i>Sources</h3>
                    <p class="text-gray-400 text-xs mb-3">Data verified from:</p>
                    <div id="scrapedSourcesList" class="space-y-2"></div>
                </div>

                <!-- Training Tip -->
                <div id="geminiTipCard" class="card hidden rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 relative overflow-hidden animate-fade-in">
                    <div class="absolute top-0 left-0 w-1 h-full" style="background-color: #5EF5C8;"></div>
                    <h3 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-lightbulb mr-2" style="color: #5EF5C8;"></i>Training Tip</h3>
                    <p class="text-gray-300 text-sm leading-relaxed" id="geminiTipText">Loading...</p>
                </div>

                <!-- Actions -->
                <div class="space-y-3 animate-fade-in">
                    <a href="#" id="buyLink" target="_blank" class="block w-full bg-white text-black font-bold text-center py-3 rounded hover:bg-gray-200 transition text-sm sm:text-base">
                        Find on Bergfreunde (~€<span id="resultPrice">000</span>) <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-xs"></i>
                    </a>
                    <button onclick="getTrainingTip()" id="tipButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded transition flex items-center justify-center space-x-2 text-sm sm:text-base">
                        <span id="tipButtonText">✨ Get Training Tip</span>
                        <i id="tipButtonIcon" class="fa-solid fa-lightbulb"></i>
                    </button>
                    <button onclick="resetApp()" class="block w-full text-gray-500 text-sm hover:text-white transition">Start Over</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION (EDIT THESE VALUES)
        // ============================================
        const YOUR_GOOGLE_API_KEY = "AIzaSyAr2-LT4o4_XDRks4Sv1awa0xmo7XpfIuc";
        const YOUR_AWIN_AFFILIATE_ID = "YOUR_AWIN_ID_HERE";
        const BERGFREUNDE_AWIN_MID = "13425";

        // ============================================
        // ENHANCED SHOE DATABASE (35+ models)
        // ============================================
        const SHOE_DB = [
            // La Sportiva - Performance
            { brand: "La Sportiva", model: "Solution", type: "aggressive", style: ["indoor", "sport"], volume: "low", shapes: ["narrow", "regular"], downsize: 2.0, price: 179, proven: true },
            { brand: "La Sportiva", model: "Solution Comp", type: "aggressive", style: ["indoor"], volume: "low", shapes: ["narrow", "regular"], downsize: 1.5, price: 189, proven: true },
            { brand: "La Sportiva", model: "Theory", type: "aggressive", style: ["indoor"], volume: "low", shapes: ["narrow", "regular"], downsize: 1.5, price: 189, proven: true },
            { brand: "La Sportiva", model: "Futura", type: "aggressive", style: ["indoor", "sport"], volume: "medium", shapes: ["regular", "wide"], downsize: 1.5, price: 179, proven: true },
            { brand: "La Sportiva", model: "Skwama", type: "aggressive", style: ["indoor", "sport"], volume: "high", shapes: ["wide", "regular"], downsize: 1.5, price: 179, proven: true },
            { brand: "La Sportiva", model: "Genius", type: "aggressive", style: ["indoor"], volume: "medium", shapes: ["regular"], downsize: 1.5, price: 185, proven: true },
            
            // La Sportiva - Moderate/Trad
            { brand: "La Sportiva", model: "Miura VS", type: "moderate", style: ["sport", "trad"], volume: "medium", shapes: ["narrow", "regular"], downsize: 2.0, price: 185, proven: true },
            { brand: "La Sportiva", model: "Miura", type: "moderate", style: ["sport"], volume: "low", shapes: ["narrow"], downsize: 2.0, price: 185, proven: true },
            { brand: "La Sportiva", model: "Katana", type: "moderate", style: ["sport", "trad"], volume: "medium", shapes: ["regular"], downsize: 1.5, price: 165, proven: true },
            { brand: "La Sportiva", model: "TC Pro", type: "neutral", style: ["trad"], volume: "medium", shapes: ["regular"], downsize: 1.0, price: 199, proven: true },
            { brand: "La Sportiva", model: "Tarantulace", type: "neutral", style: ["trad", "sport"], volume: "high", shapes: ["regular", "wide"], downsize: 1.0, price: 89, proven: true },
            { brand: "La Sportiva", model: "Finale", type: "neutral", style: ["trad", "sport"], volume: "medium", shapes: ["regular"], downsize: 1.0, price: 95, proven: true },
            { brand: "La Sportiva", model: "Otaki", type: "moderate", style: ["sport"], volume: "medium", shapes: ["regular", "wide"], downsize: 1.5, price: 159, proven: true },
            
            // Scarpa - Performance
            { brand: "Scarpa", model: "Drago", type: "aggressive", style: ["indoor"], volume: "medium", shapes: ["wide", "regular"], downsize: 1.0, price: 169, proven: true },
            { brand: "Scarpa", model: "Furia S", type: "aggressive", style: ["indoor"], volume: "low", shapes: ["narrow", "regular"], downsize: 1.0, price: 189, proven: true },
            { brand: "Scarpa", model: "Instinct VSR", type: "aggressive", style: ["indoor", "sport"], volume: "medium", shapes: ["narrow", "regular"], downsize: 1.5, price: 175, proven: true },
            { brand: "Scarpa", model: "Instinct VS", type: "moderate", style: ["sport"], volume: "medium", shapes: ["regular"], downsize: 1.5, price: 169, proven: true },
            { brand: "Scarpa", model: "Boostic", type: "aggressive", style: ["indoor", "sport"], volume: "high", shapes: ["wide", "regular"], downsize: 1.0, price: 169, proven: true },
            { brand: "Scarpa", model: "Vapor V", type: "moderate", style: ["sport", "trad"], volume: "medium", shapes: ["regular"], downsize: 1.0, price: 165, proven: true },
            { brand: "Scarpa", model: "Chimera", type: "aggressive", style: ["indoor"], volume: "low", shapes: ["narrow"], downsize: 1.0, price: 185, proven: true },
            
            // Scarpa - Moderate/Beginner
            { brand: "Scarpa", model: "Helix", type: "neutral", style: ["trad"], volume: "medium", shapes: ["regular"], downsize: 0.5, price: 119, proven: true },
            { brand: "Scarpa", model: "Origin", type: "neutral", style: ["trad"], volume: "high", shapes: ["wide", "regular"], downsize: 0.5, price: 89, proven: true },
            
            // Five Ten
            { brand: "Five Ten", model: "Hiangle", type: "moderate", style: ["indoor", "sport"], volume: "medium", shapes: ["regular", "wide"], downsize: 0.5, price: 150, proven: true },
            { brand: "Five Ten", model: "Hiangle Pro", type: "aggressive", style: ["indoor"], volume: "low", shapes: ["narrow", "regular"], downsize: 0.5, price: 165, proven: true },
            { brand: "Five Ten", model: "Anasazi Pro", type: "moderate", style: ["sport"], volume: "low", shapes: ["narrow"], downsize: 0.5, price: 145, proven: true },
            { brand: "Five Ten", model: "Quantum", type: "moderate", style: ["sport"], volume: "medium", shapes: ["regular"], downsize: 0.5, price: 149, proven: true },
            { brand: "Five Ten", model: "Kirigami", type: "moderate", style: ["indoor"], volume: "high", shapes: ["wide", "regular"], downsize: 0.5, price: 139, proven: true },
            
            // Tenaya
            { brand: "Tenaya", model: "Oasi", type: "aggressive", style: ["indoor"], volume: "medium", shapes: ["regular"], downsize: 1.5, price: 179, proven: true },
            { brand: "Tenaya", model: "Iati", type: "aggressive", style: ["indoor", "sport"], volume: "low", shapes: ["narrow"], downsize: 1.5, price: 185, proven: true },
            { brand: "Tenaya", model: "Mundaka", type: "aggressive", style: ["indoor"], volume: "high", shapes: ["wide", "regular"], downsize: 1.0, price: 169, proven: true },
            { brand: "Tenaya", model: "Ra", type: "moderate", style: ["sport"], volume: "medium", shapes: ["regular"], downsize: 1.0, price: 159, proven: true },
            
            // Evolv
            { brand: "Evolv", model: "Shaman", type: "aggressive", style: ["indoor", "sport"], volume: "high", shapes: ["wide", "regular"], downsize: 0.5, price: 169, proven: true },
            { brand: "Evolv", model: "Phantom", type: "aggressive", style: ["indoor"], volume: "low", shapes: ["narrow"], downsize: 0.5, price: 179, proven: true },
            { brand: "Evolv", model: "Zenist", type: "moderate", style: ["sport"], volume: "medium", shapes: ["regular"], downsize: 0.0, price: 149, proven: true },
            { brand: "Evolv", model: "Shakra", type: "neutral", style: ["trad"], volume: "high", shapes: ["wide"], downsize: 0.0, price: 129, proven: true }
        ];

        // ============================================
        // MOCK DATA
        // ============================================
        const MOCK_SHOE_DATA = {
            brand: "La Sportiva",
            model: "Futura (Demo)",
            recommendedSizeEU: 40.5,
            currentPriceEU: 179,
            productURL: "https://www.bergfreunde.eu/",
            productImageURL: "https://www.bergfreunde.eu/out/pictures/generated/product/1/300_300_75/135-0186-01_pic1_1.jpg",
            discountMessage: "Demo alert: This is sample discount data",
            reasoning: "Demo mode active. Turn off for live AI recommendations with real sizing calculations based on bergfreunde.eu stock.",
            optimizedFor: "Performance"
        };
        const MOCK_SOURCES = [
            { uri: "#", title: "Demo: Community Forum" },
            { uri: "#", title: "Demo: Reddit Thread" }
        ];
        
        const LOADING_MESSAGES = [
            "Analyzing your profile...",
            "Checking live inventory...",
            "Calculating sizing algorithm...",
            "Consulting community data...",
            "Finding your perfect match..."
        ];
        let loadingInterval;

        // ============================================
        // UI FUNCTIONS
        // ============================================
        function adjustSize(amount) {
            const input = document.getElementById('streetSize');
            let val = parseFloat(input.value) + amount;
            input.value = val.toFixed(1);
        }

        function selectButton(className, value, btn) {
            let inputId = '';
            if (className === 'shape-btn') inputId = 'footShape';
            else if (className === 'style-btn') inputId = 'climbingStyle';
            else if (className === 'type-btn') inputId = 'shoeType';
            
            if (inputId) {
                document.getElementById(inputId).value = value;
                document.querySelectorAll(`.${className}`).forEach(b => b.classList.remove('selected-shape'));
                btn.classList.add('selected-shape');
            }
        }
        
        function updateFitLabel(value) {
            const label = document.getElementById('fitLabel');
            if (value < 30) label.innerText = "Comfort";
            else if (value < 70) label.innerText = "Balanced";
            else label.innerText = "Performance";
        }

        function toggleDemoText(isChecked) {
            const text = document.getElementById('demoModeText');
            text.innerText = isChecked 
                ? "Demo Mode ON. Instant mock results (no API needed)."
                : "Demo Mode OFF. Live AI recommendations enabled.";
        }
        
        window.onload = () => {
            document.getElementById('budgetLabel').innerText = document.getElementById('budget').value;
            updateFitLabel(document.getElementById('fitPref').value);
            toggleDemoText(document.getElementById('demoMode').checked);
        };

        function showLoading(isLoading, message = "Find My Perfect Fit") {
            const btn = document.getElementById('calculateButton');
            const text = document.getElementById('calculateButtonText');
            const icon = document.getElementById('calculateButtonIcon');
            const errorMsg = document.getElementById('errorMessage');
            
            btn.disabled = isLoading;
            errorMsg.classList.add('hidden');
            
            if (isLoading) {
                icon.className = "spinner";
                let msgIndex = 0;
                text.innerText = LOADING_MESSAGES[msgIndex];
                loadingInterval = setInterval(() => {
                    msgIndex = (msgIndex + 1) % LOADING_MESSAGES.length;
                    text.innerText = LOADING_MESSAGES[msgIndex];
                }, 2000);
            } else {
                clearInterval(loadingInterval);
                text.innerText = message;
                icon.className = "fa-solid fa-bolt";
            }
        }

        function showTipLoading(isLoading) {
            const btn = document.getElementById('tipButton');
            const text = document.getElementById('tipButtonText');
            const icon = document.getElementById('tipButtonIcon');
            const card = document.getElementById('geminiTipCard');
            const cardText = document.getElementById('geminiTipText');
            btn.disabled = isLoading;
            if (isLoading) {
                card.classList.remove('hidden');
                cardText.innerText = "Generating personalized tip...";
                text.innerText = "Generating...";
                icon.className = "spinner";
            } else {
                text.innerText = "✨ Get Training Tip";
                icon.className = "fa-solid fa-lightbulb";
            }
        }

        function resetApp() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('geminiTipCard').classList.add('hidden');
            document.getElementById('scrapedSourcesCard').classList.add('hidden');
            document.getElementById('discountAlertCard').classList.add('hidden');
            document.getElementById('inputForm').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            showLoading(false);
            showTipLoading(false);
        }

        // ============================================
        // GEMINI API
        // ============================================
        async function callGemini(systemPrompt, userQuery, isJson = false, useGrounding = false, maxRetries = 3) {
            if (!YOUR_GOOGLE_API_KEY || YOUR_GOOGLE_API_KEY.length < 30 || YOUR_GOOGLE_API_KEY.includes("YOUR_API_KEY")) {
                throw new Error("MISSING_API_KEY");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${YOUR_GOOGLE_API_KEY}`;
            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: userQuery }] }],
            };
            if (isJson) payload.generationConfig = { responseMimeType: "application/json" };
            if (useGrounding) payload.tools = [{ "google_search": {} }];

            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`API_ERROR_${response.status}`);
                    }
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata?.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attr => ({
                                    uri: attr.web?.uri,
                                    title: attr.web?.title,
                                }))
                                .filter(s => s.uri && s.title);
                        }
                        return { text, sources };
                    } else {
                        throw new Error("Invalid API response structure");
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    const delay = Math.pow(2, attempt - 1) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("All retries failed");
        }

        // ============================================
        // CORE LOGIC
        // ============================================
        async function calculateFit() {
            showLoading(true);
            const errorBox = document.getElementById('errorMessage');
            
            try {
                const isDemoMode = document.getElementById('demoMode').checked;
                if (isDemoMode) {
                    setTimeout(() => {
                        displayResult(MOCK_SHOE_DATA, MOCK_SOURCES);
                        showLoading(false);
                    }, 1500);
                    return;
                }

                const streetSize = parseFloat(document.getElementById('streetSize').value);
                const shape = document.getElementById('footShape').value;
                const style = document.getElementById('climbingStyle').value;
                const level = document.getElementById('level').value;
                const budget = parseInt(document.getElementById('budget').value);
                const shoeType = document.getElementById('shoeType').value;
                const pref = parseInt(document.getElementById('fitPref').value);
                let fitText = (pref < 30) ? "Comfort" : (pref < 70) ? "Balanced" : "Performance";

                // STEP 1: Search bergfreunde.eu
                const systemPrompt_Search = `You are an expert climbing gear buyer. Find 3-5 proven, well-reviewed climbing shoes on bergfreunde.eu.
                CRITICAL RULES:
                - Only recommend established models with strong community reputation
                - Prioritize "classics" and "best sellers" 
                - Verify IN-STOCK status
                - Include product image URL, price, sale info, sizing consensus
                - Focus on 2024-2025 available models`;

                const userPrompt_Search = `Find top-rated climbing shoes for:
                - Level: ${level}
                - Foot: ${shape}
                - Style: ${style}
                - Type: ${shoeType}
                - Budget: €${budget}
                Include stock status, pricing, and high-quality product images.`;
                
                let scrapedShoeList = "";
                let scrapedSources = [];
                
                const searchResult = await callGemini(systemPrompt_Search, userPrompt_Search, false, true);
                scrapedShoeList = searchResult.text;
                scrapedSources = searchResult.sources;

                // STEP 2: Expert sizing analysis
                const shoeDBString = JSON.stringify(SHOE_DB.filter(s => s.proven), null, 2);

                const systemPrompt_Shoe = `You are SendGuide, the most accurate climbing shoe sizing expert.

SIZING ALGORITHM (from street size):
**La Sportiva:**
- Stiff models (Miura, TC Pro, Katana): -1.5 to -2.0 sizes
- Soft models (Futura, Theory, Solution Comp, Skwama): -1.0 to -1.5 sizes

**Scarpa:**
- Stiff/moderate (Instinct VS, Vapor V): -1.0 to -1.5 sizes
- Soft (Drago, Furia S): -0.5 to -1.0 sizes

**Five Ten:** -0.0 to -0.5 sizes (often street size)
**Evolv:** Street size or +0.5
**Tenaya:** -1.0 to -1.5 sizes

Adjust based on fit preference:
- Comfort: Reduce downsize by 0.5
- Balanced: Standard downsize
- Performance: Add 0.5 to downsize (maximum comfort threshold)

Return ONLY valid JSON:
{
  "brand": "String",
  "model": "String",
  "recommendedSizeEU": Number,
  "currentPriceEU": Number,
  "productURL": "String or null",
  "productImageURL": "String or null",
  "discountMessage": "String or null",
  "reasoning": "String - explain sizing calculation",
  "optimizedFor": "String"
}`;

                const userPrompt_Shoe = `User profile:
- Street Size: ${streetSize} EU
- Shape: ${shape}
- Level: ${level}
- Style: ${style}
- Fit Preference: ${fitText}
- Budget: €${budget}

Live inventory from bergfreunde.eu:
${scrapedShoeList}

Classic proven models database:
${shoeDBString}

Select the single best IN-STOCK shoe. Calculate exact EU size using the algorithm. Include direct product URL and image.`;

                const jsonResponse = await callGemini(systemPrompt_Shoe, userPrompt_Shoe, true, false);
                const shoeData = JSON.parse(jsonResponse.text);
                displayResult(shoeData, scrapedSources);

            } catch (error) {
                console.error("Error in calculateFit:", error);
                errorBox.classList.remove('hidden');
                
                let userFriendlyError = "An error occurred. Please try again.";
                if (error.message.includes("API_ERROR_403")) {
                    userFriendlyError = "<b>API Key Restriction Error (403):</b> Your Google API key's website restrictions are blocking this request. Please verify your domain settings in Google Cloud Console match exactly: <code>ivant24-ai.github.io/*</code> and <code>ivangtodorov24.wixsite.com/*</code>";
                } else if (error.message.includes("API_ERROR_400")) {
                    userFriendlyError = "<b>Invalid Request (400):</b> Check that your API key is valid and the Generative Language API is enabled in Google Cloud.";
                } else if (error.message.includes("API_ERROR_429")) {
                    userFriendlyError = "<b>Rate Limit (429):</b> Too many requests. Please wait a moment and try again.";
                } else if (error.message.includes("MISSING_API_KEY")) {
                    userFriendlyError = "<b>API Key Missing:</b> Please add your Google API key at the top of the script section in index.html. Get one at <a href='https://aistudio.google.com/app/apikey' target='_blank' class='underline'>Google AI Studio</a>.";
                } else {
                    userFriendlyError = `<b>Error:</b> ${error.message}`;
                }
                errorBox.innerHTML = userFriendlyError;
                
            } finally {
                showLoading(false);
            }
        }

        async function getTrainingTip() {
            showTipLoading(true);

            const isDemoMode = document.getElementById('demoMode').checked;
            if (isDemoMode) {
                setTimeout(() => {
                    document.getElementById('geminiTipText').innerText = "Demo tip: Focus on footwork drills to maximize your new shoes' performance. Turn off Demo Mode for personalized AI coaching.";
                    showTipLoading(false);
                }, 1000);
                return;
            }
            
            try {
                const level = document.getElementById('level').options[document.getElementById('level').selectedIndex].text;
                const shoeModel = document.getElementById('resultModel').innerText;
                const style = document.getElementById('climbingStyle').value;
                const shoeType = document.getElementById('shoeType').value;

                const systemPrompt_Tip = `You are an elite climbing coach. Provide concise, actionable training advice (2-3 sentences max). Be specific and encouraging.`;
                
                const userPrompt_Tip = `My level: ${level}
My shoe: ${shoeModel} (${shoeType} type)
Style: ${style}
Give me ONE specific training tip to progress with these shoes.`;

                const tipResult = await callGemini(systemPrompt_Tip, userPrompt_Tip);
                document.getElementById('geminiTipText').innerText = tipResult.text;
                
            } catch (error) {
                console.error("Failed to get tip:", error);
                document.getElementById('geminiTipText').innerText = "Unable to generate tip. Please try again.";
            } finally {
                showTipLoading(false);
            }
        }

        // ============================================
        // DISPLAY
        // ============================================
        function displayResult(shoeData, sources = []) {
            document.getElementById('inputForm').classList.add('hidden');
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('hidden');
            window.scrollTo(0, 0);
            
            const imgEl = document.getElementById('resultImage');
            if (shoeData.productImageURL) {
                imgEl.src = shoeData.productImageURL;
                imgEl.classList.remove('hidden');
            } else {
                imgEl.classList.add('hidden');
            }

            document.getElementById('resultModel').innerText = `${shoeData.brand} ${shoeData.model}`;
            document.getElementById('resultSize').innerText = `EU ${shoeData.recommendedSizeEU}`;
            document.getElementById('resultPrice').innerText = shoeData.currentPriceEU;
            document.getElementById('resultOptimizedFor').innerText = shoeData.optimizedFor;
            document.getElementById('resultLogic').innerText = shoeData.reasoning;
            
            const buyLink = document.getElementById('buyLink');
            let targetURL = shoeData.productURL || `https://www.bergfreunde.eu/search/?query=${encodeURIComponent(shoeData.brand + ' ' + shoeData.model)}`;
            
            if (YOUR_AWIN_AFFILIATE_ID && !YOUR_AWIN_AFFILIATE_ID.includes("YOUR_AWIN")) {
                const encodedURL = encodeURIComponent(targetURL);
                buyLink.href = `https://www.awin1.com/cread.php?awinmid=${BERGFREUNDE_AWIN_MID}&awinaffid=${YOUR_AWIN_AFFILIATE_ID}&ued=${encodedURL}`;
            } else {
                buyLink.href = targetURL;
            }
            
            const discountCard = document.getElementById('discountAlertCard');
            const discountText = document.getElementById('discountMessageText');
            if (shoeData.discountMessage) {
                discountText.innerText = shoeData.discountMessage;
                discountCard.classList.remove('hidden');
            } else {
                discountCard.classList.add('hidden');
            }
            
            const sourcesCard = document.getElementById('scrapedSourcesCard');
            const sourcesList = document.getElementById('scrapedSourcesList');
            sourcesList.innerHTML = "";
            if (sources.length > 0) {
                sources.slice(0, 3).forEach(source => {
                    const sourceElement = document.createElement('a');
                    sourceElement.href = source.uri;
                    sourceElement.target = "_blank";
                    sourceElement.className = "block truncate text-sm hover:underline";
                    sourceElement.innerText = source.title;
                    sourceElement.style.color = "#5EF5C8";
                    sourcesList.appendChild(sourceElement);
                });
                sourcesCard.classList.remove('hidden');
            } else {
                sourcesCard.classList.add('hidden');
            }
        }
    </script>
</body>
</html>